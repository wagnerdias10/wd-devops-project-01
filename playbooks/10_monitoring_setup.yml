---
- name: Deploy Prometheus e Grafana com Verifica√ß√µes Robustas
  hosts: k3s_master
  become: yes

  tasks:
    - name: Carregar vari√°veis de secrets.yml (se existir)
      ansible.builtin.include_vars:
        file: group_vars/secrets.yml
      failed_when: false
      ignore_errors: yes

    - name: Definir senha padr√£o se n√£o foi carregada
      ansible.builtin.set_fact:
        grafana_admin_password: "Admin@123456"
      when: grafana_admin_password is not defined

    - name: Exibir aviso sobre senha
      ansible.builtin.debug:
        msg: "‚ö†Ô∏è Usando senha padr√£o. Para produ√ß√£o, crie group_vars/secrets.yml com senha personalizada."
      when: grafana_admin_password == "Admin@123456"

    - name: Verificar se k3s est√° em execu√ß√£o
      ansible.builtin.systemd:
        name: k3s
        state: started
      check_mode: yes
      register: k3s_status
      failed_when: false

    - name: Falhar se k3s n√£o estiver rodando
      ansible.builtin.fail:
        msg: "Cluster k3s n√£o est√° em execu√ß√£o. Inicie o k3s antes de prosseguir."
      when: k3s_status.status.ActiveState != "active"

    - name: Verificar se Helm est√° instalado
      ansible.builtin.command: helm version --short
      register: helm_check
      changed_when: false
      failed_when: false

    - name: Falhar se Helm n√£o estiver instalado
      ansible.builtin.fail:
        msg: "Helm n√£o encontrado. Instale o Helm antes de prosseguir."
      when: helm_check.rc != 0

    - name: Verificar biblioteca kubernetes do Python
      ansible.builtin.command: python3 -c "import kubernetes"
      register: python_k8s_check
      changed_when: false
      failed_when: false

    - name: Instalar biblioteca kubernetes se ausente
      ansible.builtin.pip:
        name: kubernetes
        executable: pip3
        state: present
      when: python_k8s_check.rc != 0

    - name: Verificar se namespace monitoring j√° existe
      kubernetes.core.k8s_info:
        kind: Namespace
        name: monitoring
        kubeconfig: /etc/rancher/k3s/k3s.yaml
      register: namespace_check
      failed_when: false

    - name: Definir namespace_exists como false por padr√£o
      ansible.builtin.set_fact:
        namespace_exists: false

    - name: Atualizar namespace_exists se encontrado
      ansible.builtin.set_fact:
        namespace_exists: true
      when:
        - namespace_check.resources is defined
        - namespace_check.resources | length > 0

    - name: Listar releases do Helm no namespace monitoring
      ansible.builtin.command: helm list -n monitoring -q
      environment:
        KUBECONFIG: /etc/rancher/k3s/k3s.yaml
      register: helm_releases
      changed_when: false
      failed_when: false

    - name: Definir prometheus_installed como false por padr√£o
      ansible.builtin.set_fact:
        prometheus_installed: false

    - name: Atualizar se Prometheus encontrado
      ansible.builtin.set_fact:
        prometheus_installed: true
      when:
        - helm_releases.rc == 0
        - "'kube-prometheus-stack' in helm_releases.stdout"

    - name: Definir port_conflict como false por padr√£o
      ansible.builtin.set_fact:
        port_conflict: false

    - name: Verificar servi√ßos no namespace monitoring
      kubernetes.core.k8s_info:
        kind: Service
        namespace: monitoring
        kubeconfig: /etc/rancher/k3s/k3s.yaml
      register: services_check
      failed_when: false
      when: namespace_exists

    - name: Buscar servi√ßos usando NodePort 30000
      ansible.builtin.set_fact:
        port_conflict: true
      loop: "{{ services_check.resources | default([]) }}"
      when:
        - namespace_exists
        - item.spec is defined
        - item.spec.type is defined
        - item.spec.type == 'NodePort'
        - item.spec.ports is defined
      loop_control:
        label: "{{ item.metadata.name }}"

    - name: Obter informa√ß√µes dos nodes
      kubernetes.core.k8s_info:
        kind: Node
        kubeconfig: /etc/rancher/k3s/k3s.yaml
      register: nodes_info

    - name: Definir cluster_ready como false por padr√£o
      ansible.builtin.set_fact:
        cluster_ready: false

    - name: Atualizar se nodes prontos encontrados
      ansible.builtin.set_fact:
        cluster_ready: true
      when:
        - nodes_info.resources is defined
        - nodes_info.resources | length > 0

    - name: Exibir relat√≥rio de verifica√ß√µes
      ansible.builtin.debug:
        msg:
          - "=========================================="
          - "üìã RELAT√ìRIO DE PR√â-INSTALA√á√ÉO"
          - "=========================================="
          - "‚úÖ K3s Status: {{ 'ATIVO' if k3s_status.status.ActiveState == 'active' else 'INATIVO' }}"
          - "‚úÖ Helm Instalado: {{ 'SIM' if helm_check.rc == 0 else 'N√ÉO' }}"
          - "‚úÖ Biblioteca Python K8s: {{ 'INSTALADA' if python_k8s_check.rc == 0 else 'AUSENTE' }}"
          - "üì¶ Namespace 'monitoring': {{ 'EXISTE' if namespace_exists else 'N√ÉO EXISTE' }}"
          - "üîç Prometheus Stack: {{ 'INSTALADO' if prometheus_installed else 'N√ÉO INSTALADO' }}"
          - "üö™ Conflito NodePort 30000: {{ 'SIM ‚ö†Ô∏è' if port_conflict else 'N√ÉO' }}"
          - "üåê Cluster Pronto: {{ 'SIM' if cluster_ready else 'N√ÉO' }}"
          - "=========================================="

    - name: Aviso se stack j√° estiver instalado
      ansible.builtin.pause:
        prompt: |

          ‚ö†Ô∏è  ATEN√á√ÉO: kube-prometheus-stack J√Å EST√Å INSTALADO!

          A opera√ß√£o ir√° ATUALIZAR a instala√ß√£o existente.

          Deseja continuar?
          - Pressione ENTER para continuar
          - Pressione Ctrl+C + A para cancelar

        seconds: 5
      when: prometheus_installed

    - name: Falhar se houver conflito de porta cr√≠tico
      ansible.builtin.fail:
        msg: |
          ‚ùå ERRO: NodePort 30000 j√° est√° em uso!

          A√ß√µes:
          1. Remova o servi√ßo conflitante
          2. Altere a porta no Helm values
      when:
        - port_conflict
        - not prometheus_installed

    - name: Adicionar reposit√≥rio Helm do Prometheus
      kubernetes.core.helm_repository:
        name: prometheus-community
        repo_url: https://prometheus-community.github.io/helm-charts
        state: present
      environment:
        KUBECONFIG: /etc/rancher/k3s/k3s.yaml

    - name: Atualizar cache do Helm
      ansible.builtin.command: helm repo update
      environment:
        KUBECONFIG: /etc/rancher/k3s/k3s.yaml
      changed_when: true

    - name: Criar namespace monitoring (se n√£o existir)
      kubernetes.core.k8s:
        name: monitoring
        api_version: v1
        kind: Namespace
        state: present
        kubeconfig: /etc/rancher/k3s/k3s.yaml

    - name: Deploy/Upgrade kube-prometheus-stack via Helm
      kubernetes.core.helm:
        name: kube-prometheus-stack
        chart_ref: prometheus-community/kube-prometheus-stack
        release_namespace: monitoring
        create_namespace: no
        kubeconfig: /etc/rancher/k3s/k3s.yaml
        update_repo_cache: yes
        wait: yes
        wait_timeout: 15m
        values:
          grafana:
            enabled: true
            service:
              type: NodePort
              nodePort: 30000
            adminPassword: "{{ grafana_admin_password }}"
            persistence:
              enabled: false
            ingress:
              enabled: false

          prometheus:
            enabled: true
            prometheusSpec:
              retention: 15d
              storageSpec: {}
              resources:
                requests:
                  memory: "1Gi"
                  cpu: "500m"
                limits:
                  memory: "2Gi"
                  cpu: "1000m"

          alertmanager:
            enabled: true
            alertmanagerSpec:
              storage: {}

          kubeStateMetrics:
            enabled: true

          nodeExporter:
            enabled: true

          prometheusOperator:
            enabled: true
      register: helm_deploy

    - name: Exibir status da instala√ß√£o
      ansible.builtin.debug:
        msg: "{{ '‚úÖ Instala√ß√£o conclu√≠da com sucesso!' if not helm_deploy.failed else '‚ùå Falha na instala√ß√£o' }}"

    - name: Aguardar 30 segundos para pods iniciarem
      ansible.builtin.pause:
        seconds: 30

    - name: Listar todos os pods no namespace monitoring
      ansible.builtin.command: kubectl get pods -n monitoring --kubeconfig=/etc/rancher/k3s/k3s.yaml
      register: all_pods
      changed_when: false

    - name: Exibir pods criados
      ansible.builtin.debug:
        msg: "{{ all_pods.stdout_lines }}"

    - name: Obter NodePort do Grafana via kubectl
      ansible.builtin.shell: |
        kubectl get svc -n monitoring kube-prometheus-stack-grafana \
          -o jsonpath='{.spec.ports[0].nodePort}' \
          --kubeconfig=/etc/rancher/k3s/k3s.yaml
      register: grafana_port_output
      changed_when: false

    - name: Definir NodePort do Grafana
      ansible.builtin.set_fact:
        grafana_nodeport: "{{ grafana_port_output.stdout }}"

    - name: Obter IP do node
      ansible.builtin.set_fact:
        node_ip: "{{ ansible_default_ipv4.address }}"

    - name: Exibir informa√ß√µes de acesso
      ansible.builtin.debug:
        msg:
          - "=========================================="
          - "‚úÖ INSTALA√á√ÉO CONCLU√çDA COM SUCESSO!"
          - "=========================================="
          - ""
          - "üìä GRAFANA:"
          - "  URL: http://{{ node_ip }}:{{ grafana_nodeport }}"
          - "  Usu√°rio: admin"
          - "  Senha: {{ grafana_admin_password }}"
          - ""
          - "üîç PROMETHEUS:"
          - "  Para acessar, use port-forward:"
          - "  kubectl port-forward -n monitoring svc/kube-prometheus-stack-prometheus 9090:9090"
          - "  URL: http://localhost:9090"
          - ""
          - "üîî ALERTMANAGER:"
          - "  Para acessar, use port-forward:"
          - "  kubectl port-forward -n monitoring svc/kube-prometheus-stack-alertmanager 9093:9093"
          - "  URL: http://localhost:9093"
          - ""
          - "=========================================="
          - "üìã COMANDOS √öTEIS:"
          - "  Ver pods: kubectl get pods -n monitoring"
          - "  Ver services: kubectl get svc -n monitoring"
          - "  Logs Grafana: kubectl logs -n monitoring -l app.kubernetes.io/name=grafana"